name: Slack Notifications-Proceed workflow

on:
  workflow_run:
    workflows: 
      - "C2D - Odoo Versions Test"
      - "C2D - Deleting All Projects"
      - "C2D - Major Functionality Test"
      - "C2D - Other Functionality Test"
      - "Slack - Notification Test"
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        if: ${{ github.event.workflow_run.conclusion == 'failure' || github.event.workflow_run.conclusion == 'success' }}
        uses: actions/download-artifact@v4
        with:
          name: cypress-results
          path: results

      - name: Parse test results
        id: parse
        run: |
          if [ -f results/results.json ]; then
            TOTAL=$(jq '.stats.tests' results/results.json)
            PASSED=$(jq '.stats.passes' results/results.json)
            FAILED=$(jq '.stats.failures' results/results.json)
            FAILED_TESTS=$(jq -r '.tests[] | select(.state=="failed") | .fullTitle' results/results.json | paste -sd ", " -)
            echo "TOTAL=$TOTAL" >> $GITHUB_ENV
            echo "PASSED=$PASSED" >> $GITHUB_ENV
            echo "FAILED=$FAILED" >> $GITHUB_ENV
            echo "FAILED_TESTS=$FAILED_TESTS" >> $GITHUB_ENV
          else
            echo "TOTAL=0" >> $GITHUB_ENV
            echo "PASSED=0" >> $GITHUB_ENV
            echo "FAILED=0" >> $GITHUB_ENV
            echo "FAILED_TESTS=No test results found" >> $GITHUB_ENV
          fi

      - name: Send Slack notification
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\":white_check_mark: Workflow *${{ github.event.workflow.name }}* succeeded for branch *${{ github.event.workflow_run.head_branch }}* (by ${{ github.event.workflow_run.actor.login }}).\\nTests: $TOTAL | :white_check_mark: $PASSED | :x: $FAILED\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\":x: Workflow *${{ github.event.workflow.name }}* failed for branch *${{ github.event.workflow_run.head_branch }}* (by ${{ github.event.workflow_run.actor.login }}).\\nTests: $TOTAL | :white_check_mark: $PASSED | :x: $FAILED\\n*Failed tests:* $FAILED_TESTS\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          fi
