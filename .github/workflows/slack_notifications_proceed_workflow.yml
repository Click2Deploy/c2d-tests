name: Slack Notifications-Proceed workflow

on:
  workflow_run:
    workflows: 
      - "C2D - Odoo Versions Test"
      - "C2D - Deleting All Projects"
      - "C2D - Major Functionality Test"
      - "C2D - Other Functionality Test"
      - "Slack - Notification Test"
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: cypress-results
          path: results
        continue-on-error: true

      - name: Parse test results
        run: |
          if [ -f results/results.json ]; then
            PASSED=$(jq '.stats.passes' results/results.json)
            FAILED=$(jq '.stats.failures' results/results.json)
            TOTAL=$(jq '.stats.tests' results/results.json)

            # Build a bullet list of failed tests
            FAILED_LIST=$(jq -r '.tests[] | select(.state=="failed") | "- " + (.title | join(" - "))' results/results.json | paste -sd "\n" -)

            echo "PASSED_COUNT=$PASSED" >> $GITHUB_ENV
            echo "FAILED_COUNT=$FAILED" >> $GITHUB_ENV
            echo "TOTAL_COUNT=$TOTAL" >> $GITHUB_ENV
            echo "FAILED_TESTS<<EOF" >> $GITHUB_ENV
            echo "$FAILED_LIST" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "PASSED_COUNT=0" >> $GITHUB_ENV
            echo "FAILED_COUNT=0" >> $GITHUB_ENV
            echo "TOTAL_COUNT=0" >> $GITHUB_ENV
            echo "FAILED_TESTS=No test results found" >> $GITHUB_ENV
          fi

      - name: Send Slack notification
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\":white_check_mark: Workflow *${{ github.event.workflow.name }}* succeeded for branch *${{ github.event.workflow_run.head_branch }}* (by ${{ github.event.workflow_run.actor.login }}).\\n*Tests:* $TOTAL_COUNT | ✅ $PASSED_COUNT | ❌ $FAILED_COUNT\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\":x: Workflow *${{ github.event.workflow.name }}* failed for branch *${{ github.event.workflow_run.head_branch }}* (by ${{ github.event.workflow_run.actor.login }}).\\n*Tests:* $TOTAL_COUNT | ✅ $PASSED_COUNT | ❌ $FAILED_COUNT\\n*Failed tests:*\\n$FAILED_TESTS\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          fi
